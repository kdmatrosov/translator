<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<link rel="stylesheet" href="./style.css">
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/mathjs/3.11.4/math.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<body>
<div id="app">
    <div class="container">
        <div class="container__text">
            <textarea class="text" v-model="text"></textarea>
        </div>
        <div class="container__bnf">
            <button @click="main">Run</button>
        </div>
        <div class="container__chart"></div>
        <div class="container__error"></div>
    </div>
</div>
<div id="chart"></div>
<script>
  new Vue({
    el: '#app',
    data: {
      header: 'Транслятор',
      projects: [],
      text: `Program
parametrs
m = 43.51
c = 0.15
p = 1.29
s = 0.35
g = 9.81
values
x1 = 0
x2 = 0
x3 = 655
x4 = 1.2
interval [0, 38]
step 1
method
x1' = x3 * cos(x4)
x2' = x3 * sin(x4)
x3' = -c * p * s * x3^2/(2*m) - g * sin(x4)
x4' = -g * cos(x4) / x3`,
      toch: 4,
      functions: [],
      params: {},
      step: 0,
      interval: [0, 0]
    },
    created(){/*
     let this.step = math.parse('x^2 + x');
     let x = math.parse('x');
     let dh = math.derivative(this.step, x);
     console.log(dh.toString());
     console.log(dh.eval({x: 3}));*/
    },
    methods: {
      main(){
        try {
          this.getFunctions(this.text.split(/method.*\n/gi)[1]);
          this.getStep(this.text.match(/step\s*(\d+)\n/));
          this.getInterval(this.text.match(/interval.*\[(.+),(.+)\]\n/));
          this.runge4();
        } catch (ex) {
          console.log(ex);
        }
      },
      getFunctions(text){
        let fs = text.trim().split('\n');
        let __functions = [];
        fs.forEach(function (f) {
          let parts = f.split('=');
          const name = parts[0].split("'")[0].trim();
          __functions.push({name, f: parts[1].trim()});
        });
        this.functions = __functions;
        const __regexp = 'values\\n' + (() => {
              let str = '';
              __functions.forEach(() => str = str + '(.*)\\n');
              return str;
            })() + 'inter';
        this.getDefaults(this.text.match(new RegExp(__regexp)));
        this.getParams(this.text.match(/parametrs(\n.*)+values/));
      },
      getDefaults(ds){
        for (let i = 1, len = ds.length; i < len; i++) {
          let d = ds[i].split('=');
          let func = this.functions.find(f => f.name === d[0].trim());
          if (func) {
            func.def = parseFloat(d[1].trim());
          }
        }
      },
      getParams(ps){
        ps = ps[0].split('parametrs\n')[1];
        ps = ps.split('\nvalues')[0];
        ps = ps.split('\n');
        ps.forEach((_ps) => {
          const p = _ps.split('=');
          this.params[p[0].trim()] = parseFloat(p[1].trim());
        })
      },
      getStep(text){
        this.step = parseFloat(text[1]);
      },
      getInterval(text){
        this.interval = [parseFloat(text[1]), parseFloat(text[2])];
      },
      calc(f, scope){
        return math.eval(f, scope);
      },
      eiler()
      {
        let i = this.interval[0] + this.step;
        let series = [];
        let y = {};
        this.functions.forEach(func => {
          series.push({
            name: func.name,
            data: [[this.interval[0], func.def]]
          });
          y[func.name] = func.def;
        });
        while (i <= this.interval[1]) {

          this.functions.forEach(func => {
            let s = series.find(ser => ser.name === func.name);
            y[func.name] = y[func.name] + this.step * this.calc(func.f, Object.assign(y, this.params, {i}));
            s.data.push([i, +y[func.name].toFixed(2)]);
          });
          i += this.step;
        }
        this.buildChart(series);

      },
      runge2()
      {
        let x = this.interval[0];
        let series = [];
        let y = {};
        this.functions.forEach(func => {
          series.push({
            name: func.name,
            data: [[this.interval[0], func.def]]
          });
          y[func.name] = func.def;
        });
        while (x <= this.interval[1]) {
          this.functions.forEach(func => {
            let s = series.find(ser => ser.name === func.name);
            s.data.push([x, +y[func.name].toFixed(2)]);
          });
          x += this.step;
        }
        this.buildChart(series);
      },
      runge4()
      {
        let i = this.interval[0] + this.step;
        let series = [];
        let y = {};
        this.functions.forEach(func => {
          series.push({
            name: func.name,
            data: [[this.interval[0], func.def]]
          });
          y[func.name] = func.def;
        });
        const rk4 = (y, x, dx, f, name) => {
          let k1 = dx * this.calc(f, Object.assign(y, this.params, {x})),
              k2 = dx * this.calc(f, Object.assign(y, this.params, {x:x + dx / 2.0, [name]: y[name] + k1 / 2.0})),
              k3 = dx * this.calc(f, Object.assign(y, this.params, {x:x + dx / 2.0, [name]: y[name] + k2 / 2.0})),
              k4 = dx * this.calc(f, Object.assign(y, this.params, {x:x + dx, [name]: y[name] + k3}));
          return y[name] + (k1 + 2.0 * k2 + 2.0 * k3 + k4) / 6.0;
        };
        while (i <= this.interval[1]) {
          this.functions.forEach(func => {
            let s = series.find(ser => ser.name === func.name);
            y[func.name] = rk4(y, i, this.step, func.f, func.name);
            s.data.push([i, +y[func.name].toFixed(2)]);
          });
          i += this.step;
        }
        this.buildChart(series);
      },
      buildChart(series)
      {
        Highcharts.chart('chart', {
          title: {
            text: 'График'
          },
          credits: {
            enabled: false
          },
          xAxis: {
            crosshair: true,
            legend: {
              enabled: false
            }
          },
          legend: {
            enabled: true
          },
          colors: ['#ff0000', '#52c81f', '#f7a35c', '#8085e9', '#90ed7d',
            '#f15c80', '#e4d354', '#2b908f', '#f45b5b', '#91e8e1', '#99C1F7'],
          plotOptions: {
            series: {
              lineWidth: 1,
              states: {
                lineWidth: 1,
                hover: {
                  lineWidth: 1
                }
              },
              marker: {
                radius: 3,
                symbol: 'triangle',
                states: {
                  hover: {
                    radius: 3
                  }
                }
              }
            }

          }, tooltip: {
            shared: true,
            pointFormat: '<span style="color:{point.color}">\u25CF</span> {series.name}: <b>{point.y}</b><br/>'
          },
          series: series
        });
      }
    }

  })
  ;
</script>
</body>
</html>